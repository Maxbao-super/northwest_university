

# 异常控制流

## 程序控制流

CPU执行的地址序列称为控制流，顺序执行或者跳转这种与程序的执行相关的方式得到的控制流称为正常控制流

程序的执行过程中碰到了意外的情况，系统需要相应的机制去处理意外的情况，该类情况称为异常控制流

## 异常控制流（Exceptional Control Flow，ECF）

定义：由于某些特殊情况引起用户程序的正常执行被打断，所形成的意外控制流称为异常控制流

理解ECF的重要性：

* 操作系统的重要功能
* 应用程序与操作系统的交互
* 编写程序
* 并发程序的执行

**异常控制流存在于计算机的各个层面**

## 异常

异常是操作系统为了响应一些事件而做出的控制流的改变。就是CPU遇到了一些特殊的情况，使得正在执行的程序被终止，转到处理异常的情况，结束之后再返回被终止的程序。

异常表

### 异常类别

异步异常：由当前程序之外的因素引起的异常

* 中断

同步异常：由当前程序本身引起的异常

* 陷阱
* 故障
* 终止

#### 中断

引起原因：

* 定时器触发
* 外部设备的输入输出

中断一定发生在一条指令结束后，返回到当前指令的下一条

#### 陷阱和系统调用

陷阱是专门实现的异常，它发生在程序内部，是预先安排的事件，如单步跟踪、断点等。

系统调用：利用陷阱提供了一种机制用来实现用户程序和内核之间的访问接口。

#### 故障

故障由错误情况引起。但是可以被处理程序修正。但是修正之需要重新执行这条引起故障的指令

故障发生时，处理器将控制转移给故障处理程序，如果处理程序能够修正错误，就把控制返回到引起故障的指令，否则返回给内核中的 abort 例程，abort 会终止当前的应用程序。

#### 终止

也是由错误引起的，但是这种错误不能修复而且不能确定错误是哪条指令产生的，一旦出现终止，控制将会给Abort的例程，中止当前的应用程序

> | 事件         | 异常 |
> | ------------ | ---- |
> | 硬件电路故障 | 终止 |
> | 数据溢出     | 故障 |
> | 缺页         | 故障 |
> | 非法指令     | 终止 |
> | 除数为零     |      |
> | 断点设置     |      |

### 系统调用

每个系统调用都有一个唯一的ID号

## 异常指令处理

## 进程



### 逻辑控制流

每个进程都是一个逻辑控制流

**并发&顺序**：如果两个逻辑流在时间上有重叠，则称是并发的，否则是顺序的

**并发流**：一个逻辑流在执行时间上与另一个流重叠，称为并发流

**多任务**：一个进程与其他进程轮流运行称为多任务

**时间分片**：一个进程执行它的控制流的一部分的每一时间段称为时间片，所以多任务称为时间分片

**并行流**：如果两个流并发地运行在不同的处理机或者是处理器核心上，就称之为并行流

**私有地址空间**：Linux平台每个进程都有独立的私有地址空间(虚拟地址空间)，每个进程的地址空间划分布局相同

![](img\进程私有地址空间.png)

#### 内核模式

内核空间存放的是操作系统内核代码和数据，是被所有程序共享的，在程序中修改内核空间中的数据不仅会影响操作系统本身的稳定性，还会影响其他程序，所以操作系统禁止用户程序直接访问内核空间

#### 用户模式

#### 为什么内核和用户要共用地址空间

发生系统调用时进行的是模式切换，模式切换仅仅需要寄存器进栈出栈，不会导致缓存失效

#### 上下文切换

每个任务运行前，CPU 都需要知道任务从哪里加载、又从哪里开始运行，这就涉及到 CPU 寄存器 和程序计数器（PC）

CPU 寄存器是 CPU 内置的容量小、但速度极快的内存；

程序计数器会存储 CPU 正在执行的指令位置，或者即将执行的指令位置。

这两个是 CPU 运行任何任务前都必须依赖的环境，因此叫做 CPU 上下文
